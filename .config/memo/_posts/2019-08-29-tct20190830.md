# tct20190830


<サマリー> 
東京海上日動火災保険株式会社様はでIMS DBを分散サーバーへデータレプリケーションするプロジェクトを実施中です。
データの受け渡し部にMQを使用されており、その設計に技術的な問題がないか、レビューいたしました。


<環境>
z/OS V2.1
IMS V13.1
MQ V8.0

- z/OS-分散のDQM接続
- トランザクションには二種類あり、メッセージ量が多い大量型と、1件ずつ送る1件型がある。
- MQはグループメッセージを仕様
- 文字コード変換はなし
- メッセージ量は平均500kb、最大は260mb
<アクション事項>
申込者側: 特になし

担当者側: 特になし

<ご質問>

- 今回のようにトランザクションが二種類あり、片方のトランザクション量が多い場合、チャネルが一本だと1件型に影響が出ないか


グループメッセージのプットをワンコミットで行うとすると、260MBのメッセージがキューにいっぺんに貯まるため、1件型がその後ろに入って260mbが処理されるまで時間がかかる場合があります。

チャネルを大量型と1件型で分けても良いと考えます。

- 何かログまわりでチューニングしておくべき設定があればご教示願いたい



ディスク性能によるが、1メッセージが大きければ効率が良いので、問題ないと思われる。

パフォーマンスレポート参照してください。

- 有事切り替えについて、添付の資料の方法で再起動する簡単な方法はないか

図の状況であると、5:30のBSDS,PAGESET,ARCHIVE LOGで起動することになります。
災対時の切り替えの手順については以下を参照していただければと思います。

https://www.ibm.com/support/knowledgecenter/en/SSFKSJ_8.0.0/com.ibm.mq.adm.doc/q022650_.htm#q022650___RecoveringASingleQueueManagerAtAnA


上記の手順は、複雑であるため、代替手段としてはキューマネージャーの作り直しが考えられます。


また、以下の方法でキューマネージャーの再起動により回復が可能です。

- CG1にBSDS,ARCHIVE LOGを移し、一分前のデータで再起動する
- CG2にARCHIVE LOGの副ログを入れ、災対サイトでは片系障害として、副ログを正ログにコピーし5:30の状態で再起動する



- 切り替えの手順について

QMGR名が変わる場合、ネーミングルールに則るのであればチャネル名のALTERもしくは、初期でDEFINEしておき、切り替えが必要となります。RQMNAMEも同様です。

DEL/DEFとALTERに関しては、お好きな方法で行っていただいてよろしいです。

また、どの方法でもCHANNELのリセットは必要となります。



- その他ご質問
 - BATCHSIZE-5, BATCH INTERVAL=0 について

  バッチサイズに関しては、オンライントランザクションを基に設定されているようなので、今回はもうすこし大きくしても良いと考えます。
  defaultのBATCHSIZEは50です。


- check pointの頻度に関して
 見積もり上ACTIVE LOGののスイッチのほうが早いため、現在の設定で問題ないと考えます。

 テストの中でチェックポイントが頻発するようであればLOGのサイズとLOGLOAD を調整してください。

- ログバッファー書き出ししきい値 CSQ6LOGP WRTHRSH = 20
パフォーマンステストの結果でwaitlogが発生するようであれば調整してください。
```
話の中で多分WRTHRSHを%で勘違いしてたのですが訂正したほうがよいでょうか？
```

- LOG RBA について
8byte RBA にしてもよいと考えます。


- XMITQのバッファーについて
85%のしきい値を考慮して設定するのが良いと考えます。
チャネルを分けるのであれば、トランスミッションキューも分け、バッファーも分けることをおすすめします。
バッファーを分けることで大量型の影響が1件型に出にくくなります。

- MQのメッセージ処理”スピード”をモニタリング可能か
できません。

キューの滞留時間を見るためにはSMFのクラス3を取る必要があります。

どうしても必要であるのならば、自作のログシステムを作る必要があります。

- LISTENERは必要か
今回は送信のみであるため必要ないです。

- 詳細設定のエクセルに関して

 - シート概要設計_MQ
  - MQクラスタの説明について
   - クラスタは他対他でなくてもいい。一対一で構築した場合は、ラウンドロビンも発生しない。

 - シート詳細設計_MQ設計
  - MAXUMSGS
    - 見込まれる同一コミット内のメッセージ数130(260mb/2mb)に対して200000は大きいと思われます

activelog

少ない印象
peak時から計算して


bufferpool

チャネルをわけるならページセットも分けていい


pageset
default のサイズがもう少し大きい

CHIADAPS
CHIDISPS

デフォルトでいい
smfの情報を添付する
むやみに大きくする必要はないし小さくする必要もない


デフォルトclientchannel削除スる？








-----------------------

IMS-ODSのQrepの案件
A

z/osと分散のDQM接続
グループメッセージを仕様
文字コード変換はなし

ホスト側の処理が3秒
サーバー側処理が7秒(結構早いらしい)

平均500kb
最大で260mb(2mb*nのグループメッセージ)
秒20 ken
persistent
ログ、62GB /日　平均3mb peak 10mb

z14
zos 2.1 imsv13.1   mq v8


v8 は来年の４月にサポートが切れる
再来年upよてい



- チャネル本数について
    A

グループメッセーじのプットをワンコミットで行うとすると、260MBのメッセージがキューにいっぺんに貯まるため、1件型が後ろに入って260mbが処理されるまで時間がかかる

チャネル分けても良いと思う


- log
10mb/secの書き込みがある

処理として軽くはない

ディスク性能によるけれど、ワンメッセージが大きければ効率が良いので、大丈夫そう？

1mbのメッセージでも11mb/secでてるので大丈夫だと思う

パフォーマンスレポート参照


- 災対

ディスクグループによって一分前と一日二回のデータ移動がある

アクティブログが一分前にあるのは、最後にmqputしたという情報をlogから探したい




その情報をさんこうにデータベースの整合性を保つように何らかの操作を行う

activelogの片系を定時に乗っけて片障害として起動することは可能？

有事、訓練以外では災対に切り替えることはない

activelogの中身はprintのやつがある
https://www.ibm.com/support/knowledgecenter/en/SSFKSJ_9.0.0/com.ibm.mq.ref.adm.doc/q088970_.htm

かんたんに読めるものではない


災対でコールドスタートするのであれば、オブジェクトの情報だけを送信して、残りを空のものを作っておいて上げるという方法もある






- 切り替え手順

channelのリセット
channel ipaddress


相手側のQMGR名が変わると様々な変更点がある

channel名

RQの定義のRMQNAME

- その他
-
バッチサイズ　もう少し大きくていいと思う

channel を分けるならば
グループメッセージはdefaultの50でもいいと思う
オンライントランザクション処理なら5とかでもいいけど

通常の方は5-0でいいと思う


- check point 一日数回だけど頻度すくないかなという
activelogのスイッチのほうが早い

activelog一巡で2時間

logloadは100000000でもいいと思う

テストしながらチェックポイントが頻発するようであればlogのサイズとlogload を調整

- outbaffとう
パフォーマンステストの結果でwaitlogが発生した

多分WRTHRSHを%で勘違いしてるから訂正する？

- 8byteRBAにしなくていい？
8byteにしてもいいと思う


- xmitq baffer
85%に合わせるようにする
チャネルをわけるならトランスミッションキューを分けて、バッファーも分けるほうが良いと思う
1件型にバッファーによる圧迫がなくなるから　鮮度が保てる

- mqのメッセージ処理のモニタリングが可能か
見れない、

キューの滞留時間を見るためにはSMFのクラス3を取る必要がある

必要であるのならば自作のログシステムを作る必要がある

- listenerは
今回は必要ない
使うならportを開ける必要がある


完全一方向のQMGRは珍しい

クラスタは他対他でなくてもいい


MAXUMSGS

130に対して200000は大きい
default でもいいと思う

activelog

少ない印象
peak時から計算して


bufferpool

チャネルをわけるならページセットも分けていい


pageset
default のサイズがもう少し大きい

CHIADAPS
CHIDISPS

デフォルトでいい
smfの情報を添付する
むやみに大きくする必要はないし小さくする必要もない


デフォルトclientchannel削除スる？








- 多くは既存のMQに合わせて、というような設計としています。とはいえ、設計として深堀して考えておいた方がよい点があれば、きちんと考えておきたいです。
 - BATCHSIZE-5, BATCH INTERVAL=0
マニュアルに記述されているよりもバッチサイズは少ない
スループットが目標に達しない場合はサイズを大きくすることも視野に入れる？




- チェックポイント頻度 : CSQ6SYSP LOGLOAD=1,000,000 ※今回のMQは見積もり上、160,000 MQ PUT/日。チェックポイント頻度としては低すぎたりしますでしょうか? Archive時にCHKPT取られるからこちら側の値は気にする必要なしでしょうか?



- ログバッファー書き出ししきい値 CSQ6LOGP WRTHRSH = 20  ※OUTBUFF=4000(KB)に対してどうでしょうか。パーシステントでは考慮の余地ないという理解でよいでしょうか?
 - LOG RBA は6バイトのまま　※6バイト⇒255TB ⇒62GB/日として11年くらいはもちそう (一応2027年までと言われているので、もつといえばもつ)

□ XMITQのバッファーは、大量型TRXで260MBのMQ PUTがあるため、並行する1件型のことも加味して300MBを用意することとしています。しかし、85%のしきい値を考えると中途半端でしょうか?　(メモリに余裕があれば大きくすればいい、ということかとも思いますが何か再度エフェクトなどあればご教示ください)

□MQのメッセージ処理”スピード”をモニタリング可能でしょうか? 源泉からホストから出すまでに3秒という性能目標の証明として、求められる可能性があり、方法を整理しておきたいと考えています。 (現在もトレース取るかしないという理解で正しいでしょうか)

```
